name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Generate static HTML
        working-directory: ./wp-theme/local
        run: |
          set -e
          
          # Создаем директорию для статики
          mkdir -p ../gh-pages
          
          echo "1. Copying static files (CSS, JS, images)..."
          # Копируем все статические файлы
          cp -r assets ../gh-pages/
          cp -r template-parts ../gh-pages/ 2>/dev/null || true
          
          # Копируем favicon в корень
          if [ -f "assets/images/favicon.png" ]; then
            cp "assets/images/favicon.png" ../gh-pages/
          fi
          
          echo "2. Starting PHP server..."
          # Запускаем PHP сервер в фоне
          php -S localhost:8765 router.php > /tmp/php-server.log 2>&1 &
          SERVER_PID=$!
          
          # Ждем запуска сервера
          sleep 5
          
          # Проверяем что сервер запустился
          if ! curl -s "http://localhost:8765/" > /dev/null; then
            echo "Error: PHP server failed to start"
            cat /tmp/php-server.log
            exit 1
          fi
          
          echo "3. Generating HTML pages..."
          # Используем простой синтаксис вместо массива
          PAGES="index:/ about:/about groups:/groups programs:/programs pricing:/pricing adaptation:/adaptation enrollment:/enrollment contacts:/contacts"
          
          for page_info in $PAGES; do
            IFS=':' read -r page_name page_url <<< "$page_info"
            echo "   Generating: $page_name.html"
            
            # Загружаем страницу и исправляем пути (упрощенный синтаксис)
            curl -s "http://localhost:8765$page_url" | \
              # Сначала заменяем статические ресурсы
              sed 's|href="/assets/|href="./assets/|g' | \
              sed 's|src="/assets/|src="./assets/|g' | \
              sed 's|href="/template-parts/|href="./template-parts/|g' | \
              # Заменяем страницы с завершающим слешем - используем " чтобы захватить до кавычки
              sed 's|href="/about/"|href="./about.html"|g' | \
              sed 's|href="/groups/"|href="./groups.html"|g' | \
              sed 's|href="/programs/"|href="./programs.html"|g' | \
              sed 's|href="/pricing/"|href="./pricing.html"|g' | \
              sed 's|href="/adaptation/"|href="./adaptation.html"|g' | \
              sed 's|href="/enrollment/"|href="./enrollment.html"|g' | \
              sed 's|href="/contacts/"|href="./contacts.html"|g' | \
              # Заменяем относительные ссылки с завершающим слешем
              sed 's|href="./about/"|href="./about.html"|g' | \
              sed 's|href="./groups/"|href="./groups.html"|g' | \
              sed 's|href="./programs/"|href="./programs.html"|g' | \
              sed 's|href="./pricing/"|href="./pricing.html"|g' | \
              sed 's|href="./adaptation/"|href="./adaptation.html"|g' | \
              sed 's|href="./enrollment/"|href="./enrollment.html"|g' | \
              sed 's|href="./contacts/"|href="./contacts.html"|g' | \
              # Заменяем страницы без завершающего слеша (но с кавычкой после)
              sed 's|href="/about"|href="./about.html"|g' | \
              sed 's|href="/groups"|href="./groups.html"|g' | \
              sed 's|href="/programs"|href="./programs.html"|g' | \
              sed 's|href="/pricing"|href="./pricing.html"|g' | \
              sed 's|href="/adaptation"|href="./adaptation.html"|g' | \
              sed 's|href="/enrollment"|href="./enrollment.html"|g' | \
              sed 's|href="/contacts"|href="./contacts.html"|g' | \
              # Заменяем относительные ссылки без завершающего слеша
              sed 's|href="./about"|href="./about.html"|g' | \
              sed 's|href="./groups"|href="./groups.html"|g' | \
              sed 's|href="./programs"|href="./programs.html"|g' | \
              sed 's|href="./pricing"|href="./pricing.html"|g' | \
              sed 's|href="./adaptation"|href="./adaptation.html"|g' | \
              sed 's|href="./enrollment"|href="./enrollment.html"|g' | \
              sed 's|href="./contacts"|href="./contacts.html"|g' | \
              # Заменяем главную страницу (только если это отдельная ссылка)
              sed 's|href="/"|href="./index.html"|g' | \
              sed 's|href="./"|href="./index.html"|g' | \
              # Общие замены путей для остальных ресурсов (делаем в конце, чтобы не перезаписать предыдущие)
              sed 's|href="/|href="./|g' | \
              sed 's|src="/|src="./|g' > "../gh-pages/$page_name.html"
            
            # Проверяем что файл создан
            if [ ! -s "../gh-pages/$page_name.html" ]; then
              echo "   Warning: $page_name.html is empty"
            else
              echo "   ✅ $page_name.html created"
            fi
          done
          
          echo "4. Stopping PHP server..."
          # Останавливаем сервер
          kill $SERVER_PID 2>/dev/null || true
          sleep 1
          
          echo "5. Creating .nojekyll..."
          # Создаем .nojekyll чтобы GitHub Pages не обрабатывал файлы через Jekyll
          touch ../gh-pages/.nojekyll
          
          echo ""
          echo "✅ Static site generated successfully!"
          echo "   HTML pages: $(find ../gh-pages -maxdepth 1 -name "*.html" 2>/dev/null | wc -l)"
          echo "   Images: $(find ../gh-pages/assets/images -type f 2>/dev/null | wc -l)"
          echo "   CSS files: $(find ../gh-pages/assets/css -type f 2>/dev/null | wc -l)"
          echo "   JS files: $(find ../gh-pages/assets/js -type f 2>/dev/null | wc -l)"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './wp-theme/gh-pages'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

